name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.5 or 0.5-test)'
        required: true
        type: string
      build_windows:
        description: 'Build Windows'
        required: false
        type: boolean
        default: true
      build_macos_arm64:
        description: 'Build macOS ARM64'
        required: false
        type: boolean
        default: true
      build_macos_x86_64:
        description: 'Build macOS Intel'
        required: false
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux'
        required: false
        type: boolean
        default: true
      build_android:
        description: 'Build Android'
        required: false
        type: boolean
        default: true

jobs:
  build-windows:
    name: Windows Release
    runs-on: windows-latest
    if: ${{ inputs.build_windows }}

    steps:
    - uses: actions/checkout@v4

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11.5
      with:
        vcpkgGitCommitId: '74e6536215718009aae747d86d84b78376bf9e09'

    - name: Install dependencies
      run: |
        vcpkg install sdl2:x64-windows opus:x64-windows openal-soft:x64-windows

    - name: Configure CMake
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake"

    - name: Build
      run: cmake --build build --config Release -j

    - name: Package
      run: |
        mkdir -p release/zelda3-windows-v${{ inputs.version }}
        cp build/Release/zelda3.exe release/zelda3-windows-v${{ inputs.version }}/
        cp build/Release/*.dll release/zelda3-windows-v${{ inputs.version }}/ 2>$null || echo "No DLLs found"
        cp zelda3.ini release/zelda3-windows-v${{ inputs.version }}/
        cp README.md release/zelda3-windows-v${{ inputs.version }}/
        cp LICENSE.txt release/zelda3-windows-v${{ inputs.version }}/
        cd release
        Compress-Archive -Path zelda3-windows-v${{ inputs.version }} -DestinationPath zelda3-windows-v${{ inputs.version }}.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: zelda3-windows-v${{ inputs.version }}
        path: release/zelda3-windows-v${{ inputs.version }}.zip

  build-macos-arm64:
    name: macOS ARM64 Release
    runs-on: macos-14
    if: ${{ inputs.build_macos_arm64 }}

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install sdl2 opus openal-soft cmake

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_ARCHITECTURES=arm64

    - name: Build
      run: cmake --build build -j$(sysctl -n hw.ncpu)

    - name: Package
      run: |
        mkdir -p release/zelda3-macos-arm64-v${{ inputs.version }}
        cp build/zelda3 release/zelda3-macos-arm64-v${{ inputs.version }}/
        cp build/*.dylib release/zelda3-macos-arm64-v${{ inputs.version }}/ 2>/dev/null || echo "No dylibs found"
        cp zelda3.ini release/zelda3-macos-arm64-v${{ inputs.version }}/
        cp README.md release/zelda3-macos-arm64-v${{ inputs.version }}/
        cp LICENSE.txt release/zelda3-macos-arm64-v${{ inputs.version }}/
        cd release
        zip -r zelda3-macos-arm64-v${{ inputs.version }}.zip zelda3-macos-arm64-v${{ inputs.version }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: zelda3-macos-arm64-v${{ inputs.version }}
        path: release/zelda3-macos-arm64-v${{ inputs.version }}.zip

  build-macos-x86_64:
    name: macOS Intel Release
    runs-on: macos-13
    if: ${{ inputs.build_macos_x86_64 }}

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install sdl2 opus openal-soft cmake

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_ARCHITECTURES=x86_64

    - name: Build
      run: cmake --build build -j$(sysctl -n hw.ncpu)

    - name: Package
      run: |
        mkdir -p release/zelda3-macos-x86_64-v${{ inputs.version }}
        cp build/zelda3 release/zelda3-macos-x86_64-v${{ inputs.version }}/
        cp build/*.dylib release/zelda3-macos-x86_64-v${{ inputs.version }}/ 2>/dev/null || echo "No dylibs found"
        cp zelda3.ini release/zelda3-macos-x86_64-v${{ inputs.version }}/
        cp README.md release/zelda3-macos-x86_64-v${{ inputs.version }}/
        cp LICENSE.txt release/zelda3-macos-x86_64-v${{ inputs.version }}/
        cd release
        zip -r zelda3-macos-x86_64-v${{ inputs.version }}.zip zelda3-macos-x86_64-v${{ inputs.version }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: zelda3-macos-x86_64-v${{ inputs.version }}
        path: release/zelda3-macos-x86_64-v${{ inputs.version }}.zip

  build-linux:
    name: Linux Release
    runs-on: ubuntu-latest
    if: ${{ inputs.build_linux }}

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libsdl2-dev \
          libopus-dev \
          python3 \
          python3-pip \
          libopenal-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Package
      run: |
        mkdir -p release/zelda3-linux-v${{ inputs.version }}
        cp build/zelda3 release/zelda3-linux-v${{ inputs.version }}/
        cp build/*.so release/zelda3-linux-v${{ inputs.version }}/ 2>/dev/null || echo "No SOs found"
        cp zelda3.ini release/zelda3-linux-v${{ inputs.version }}/
        cp README.md release/zelda3-linux-v${{ inputs.version }}/
        cp LICENSE.txt release/zelda3-linux-v${{ inputs.version }}/
        cd release
        zip -r zelda3-linux-v${{ inputs.version }}.zip zelda3-linux-v${{ inputs.version }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: zelda3-linux-v${{ inputs.version }}
        path: release/zelda3-linux-v${{ inputs.version }}.zip

  build-android:
    name: Android Release
    runs-on: ubuntu-latest
    if: ${{ inputs.build_android }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Build APK
      run: |
        cd android
        chmod +x ./gradlew
        ./gradlew assembleRelease

    - name: Rename APK
      run: |
        mkdir -p release
        cp android/app/build/outputs/apk/release/app-release-unsigned.apk release/zelda3-android-v${{ inputs.version }}.apk

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: zelda3-android-v${{ inputs.version }}
        path: release/zelda3-android-v${{ inputs.version }}.apk

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos-arm64, build-macos-x86_64, build-linux, build-android]
    if: always()

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure
      run: ls -R artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ inputs.version }}
        name: Zelda3 v${{ inputs.version }}
        draft: true
        files: |
          artifacts/**/*.zip
          artifacts/**/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
